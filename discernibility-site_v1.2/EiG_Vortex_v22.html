<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EiG Vortex v21 - Axiomatic Lock</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif;
            background: #0a0a1a; 
            color: #fff; 
            overflow: hidden;
        }
        #container { width: 100vw; height: 100vh; }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid #FFD700;
            max-width: 360px;
            z-index: 100;
        }
        #info h1 { font-size: 1.2em; margin-bottom: 8px; color: #FFD700; }
        #info .subtitle { color: #4ECDC4; font-weight: bold; margin-bottom: 10px; }
        #info p { font-size: 0.75em; color: #aaa; margin: 4px 0; line-height: 1.4; }
        #info .key { color: #FF6B6B; }
        
        #axioms {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.95);
            padding: 15px 20px;
            border-radius: 8px;
            border: 2px solid #4ECDC4;
            width: 320px;
            z-index: 100;
        }
        #axioms h3 { color: #4ECDC4; margin-bottom: 12px; font-size: 0.9em; }
        #axioms .axiom { 
            margin: 8px 0; 
            padding: 8px; 
            background: rgba(78, 205, 196, 0.1);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75em;
        }
        #axioms .label { color: #888; }
        #axioms .value { color: #FFD700; font-weight: bold; }
        #axioms .derived { color: #FF6B6B; }
        #axioms .note { font-size: 0.7em; color: #666; margin-top: 2px; }
        
        #tooltip {
            position: absolute;
            background: rgba(0,0,0,0.95);
            padding: 10px 14px;
            border-radius: 6px;
            border: 1px solid #FFD700;
            pointer-events: none;
            display: none;
            z-index: 1000;
            font-size: 0.8em;
        }
        
        #legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            padding: 10px 14px;
            border-radius: 6px;
            border: 1px solid #333;
            font-size: 0.7em;
            z-index: 100;
        }
        #legend h3 { margin-bottom: 6px; color: #FFD700; }
        .legend-item { display: flex; align-items: center; margin: 3px 0; }
        .legend-color { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
        
        #controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            padding: 10px 14px;
            border-radius: 6px;
            border: 1px solid #333;
            z-index: 100;
            font-size: 0.75em;
        }
        #controls label { display: block; margin: 4px 0; cursor: pointer; }
        
        .element-label {
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 0 0 3px #000, 0 0 6px #000;
            pointer-events: none;
            white-space: nowrap;
        }
        .element-label.hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <div id="info">
        <h1>‚öõÔ∏è EiG Vortex v21</h1>
        <div class="subtitle">AXIOMATIC LOCK + SIZE CONTROLS</div>
        <p>121 Elements: E0 ‚Üí Ubn (Z=120)</p>
        <p style="margin-top:10px;">
            The 3-4-5 triangle is <span class="key">not free-floating</span>.<br>
            It is anchored by the <span class="key">Gear Lash</span> which bridges<br>
            Euclidean geometry to the 7-fold Carbon manifold.
        </p>
        <p style="margin-top:8px; color:#4ECDC4;">
            No sliders. One unique solution.<br>
            The manifold "clicks" into place.
        </p>
    </div>
    
    <div id="axioms">
        <h3>üîí LOCKED AXIOMS (v9.1)</h3>
        
        <div class="axiom">
            <span class="label">GEAR LASH:</span><br>
            <span class="value">Œ± = arctan(4/3) ‚àí 360/7</span><br>
            <span class="derived">= 53.13¬∞ ‚àí 51.43¬∞ = 1.7015¬∞</span>
            <div class="note">Bridges Euclidean ‚Üí 7-fold manifold</div>
        </div>
        
        <div class="axiom">
            <span class="label">EXPANSION:</span> <span class="value">4/3</span><br>
            <span class="note">From 3-4-5 leg ratio</span>
        </div>
        
        <div class="axiom">
            <span class="label">ORIENTATION:</span> <span class="value">90¬∞ + 1.70¬∞</span><br>
            <span class="derived">= 91.70¬∞</span>
            <div class="note">Right angle + gear lash</div>
        </div>
        
        <div class="axiom">
            <span class="label">PITCH:</span> <span class="value">‚âà 1/6</span> <span class="derived">(= Œ≥/4)</span><br>
            <div class="note">Œ≥ = 2/3 universal coupling</div>
        </div>
        
        <div class="axiom">
            <span class="label">STRETCH:</span> <span class="value">7/4 = 1.75</span><br>
            <div class="note">œÜ_p ‚Üí Œ∏ transform</div>
        </div>
    </div>
    
    <div id="tooltip"></div>
    
    <div id="legend">
        <h3>Blocks</h3>
        <div class="legend-item"><div class="legend-color" style="background: #8800FF;"></div>Vacuum (E0)</div>
        <div class="legend-item"><div class="legend-color" style="background: #FFFFFF;"></div>s-block</div>
        <div class="legend-item"><div class="legend-color" style="background: #00FFFF;"></div>Noble gases</div>
        <div class="legend-item"><div class="legend-color" style="background: #FFD700;"></div>p-block</div>
        <div class="legend-item"><div class="legend-color" style="background: #4ECDC4;"></div>d-block</div>
        <div class="legend-item"><div class="legend-color" style="background: #FF6B6B;"></div>f-block</div>
        <div class="legend-item"><div class="legend-color" style="background: #FF00FF;"></div>Period 8</div>
    </div>
    
    <div id="controls">
        <label><input type="checkbox" id="showTriangle" checked> Triangle</label>
        <label><input type="checkbox" id="showRibbons" checked> Ribbons</label>
        <label><input type="checkbox" id="showAxis" checked> Axis</label>
        <hr style="margin: 8px 0; border-color: #333;">
        <label>Size: <span id="sizeVal">1.0</span>x</label>
        <input type="range" id="sizeSlider" min="0.3" max="2.5" step="0.1" value="1.0" style="width:100%;">
        <label style="margin-top:6px;"><input type="checkbox" id="propSize"> ‚àõZ scaling</label>
        <label><input type="checkbox" id="showLabels"> Element names</label>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS2DRenderer.js"></script>
    
    <script>
// =============================================================================
// EiG VORTEX v21 - AXIOMATIC LOCK
// =============================================================================
// The 3-4-5 triangle orientation is NOT a free parameter.
// It is LOCKED by the Gear Lash: arctan(4/3) - 360/7 = 1.7015¬∞
// This bridges Euclidean geometry to the 7-fold Carbon manifold.
// =============================================================================

console.log("=== EiG VORTEX v21 - AXIOMATIC LOCK ===\n");

// =============================================================================
// LOCKED AXIOMATIC CONSTANTS
// =============================================================================

// The 3-4-5 triangle
const SIDE_3 = 3;
const SIDE_4 = 4;
const SIDE_5 = 5;

// Gear Lash: the metric tension bridging Euclidean to 7-fold
const ARCTAN_4_3 = Math.atan(4/3) * 180 / Math.PI;  // 53.1301¬∞
const CARBON_PHI = 360 / 7;                          // 51.4286¬∞
const GEAR_LASH = ARCTAN_4_3 - CARBON_PHI;           // 1.7015¬∞

// Universal coupling
const GAMMA = 2/3;

// LOCKED: Orientation angle = 90¬∞ + gear lash
const ALPHA_DEG = 90 + GEAR_LASH;  // 91.7015¬∞
const ALPHA_RAD = ALPHA_DEG * Math.PI / 180;

// LOCKED: Expansion ratio from triangle
const EXPANSION = SIDE_4 / SIDE_3;  // 4/3

// LOCKED: Stretch factor
const STRETCH = 7/4;  // 1.75

console.log("GEAR LASH = arctan(4/3) - 360/7");
console.log(`         = ${ARCTAN_4_3.toFixed(4)}¬∞ - ${CARBON_PHI.toFixed(4)}¬∞`);
console.log(`         = ${GEAR_LASH.toFixed(4)}¬∞`);
console.log(`\nOrientation Œ± = 90¬∞ + ${GEAR_LASH.toFixed(4)}¬∞ = ${ALPHA_DEG.toFixed(4)}¬∞`);

// =============================================================================
// DERIVE TRIANGLE POSITION FROM LOCKED CONSTRAINTS
// =============================================================================

// E0 at apex on axis
const APEX_HEIGHT = 4.0;
const E0 = { x: 0, y: APEX_HEIGHT, z: 0 };

// Given: expansion = 4/3 and Œ± = 91.70¬∞
// Solve for r_H such that the angle constraint is satisfied

function solveForRH() {
    // Binary search for r_H that gives Œ± = 91.70¬∞
    let lo = 2.0, hi = 2.99;
    
    for (let i = 0; i < 60; i++) {
        const mid = (lo + hi) / 2;
        const r_H = mid;
        const r_He = EXPANSION * r_H;
        
        const dh_H_sq = 9 - r_H * r_H;
        const dh_He_sq = 16 - r_He * r_He;
        
        if (dh_H_sq <= 0 || dh_He_sq <= 0) { hi = mid; continue; }
        
        const dh_H = Math.sqrt(dh_H_sq);
        const dh_He = Math.sqrt(dh_He_sq);
        const pitch = dh_He - dh_H;
        
        const cos_a = (r_H*r_H + r_He*r_He + pitch*pitch - 25) / (2 * r_H * r_He);
        if (Math.abs(cos_a) > 1) { hi = mid; continue; }
        
        const angle = Math.acos(cos_a) * 180 / Math.PI;
        
        if (angle < ALPHA_DEG) hi = mid;
        else lo = mid;
    }
    
    return (lo + hi) / 2;
}

const r_H = solveForRH();
const r_He = EXPANSION * r_H;
const dh_H = Math.sqrt(9 - r_H * r_H);
const dh_He = Math.sqrt(16 - r_He * r_He);
const PITCH = dh_He - dh_H;

// Set vertex positions
const H = { x: r_H, y: APEX_HEIGHT - dh_H, z: 0 };
const He = { 
    x: r_He * Math.cos(ALPHA_RAD), 
    y: APEX_HEIGHT - dh_He, 
    z: r_He * Math.sin(ALPHA_RAD) 
};

// Verification
const d_E0_H = Math.sqrt(H.x**2 + (E0.y - H.y)**2);
const d_E0_He = Math.sqrt(He.x**2 + (E0.y - He.y)**2 + He.z**2);
const d_H_He = Math.sqrt((H.x - He.x)**2 + (H.y - He.y)**2 + He.z**2);

console.log("\n=== DERIVED POSITIONS ===");
console.log(`r_H = ${r_H.toFixed(6)}, r_He = ${r_He.toFixed(6)}`);
console.log(`Œîh_H = ${dh_H.toFixed(6)}, Œîh_He = ${dh_He.toFixed(6)}`);
console.log(`PITCH = ${PITCH.toFixed(6)} (Œ≥/4 = ${(GAMMA/4).toFixed(6)})`);
console.log(`\nE0: (${E0.x}, ${E0.y}, ${E0.z})`);
console.log(`H:  (${H.x.toFixed(4)}, ${H.y.toFixed(4)}, ${H.z})`);
console.log(`He: (${He.x.toFixed(4)}, ${He.y.toFixed(4)}, ${He.z.toFixed(4)})`);

console.log("\n=== 3-4-5 VERIFICATION ===");
console.log(`|E0-H| = ${d_E0_H.toFixed(6)} (should be 3)`);
console.log(`|E0-He| = ${d_E0_He.toFixed(6)} (should be 4)`);
console.log(`|H-He| = ${d_H_He.toFixed(6)} (should be 5)`);

// Period spacing derived from pitch
const PERIOD_SPACING = PITCH * 3;  // Scale for visibility

// =============================================================================
// ELEMENT POSITIONING
// =============================================================================

function getPhiP(group, block, Z) {
    if (Z === 0) return ALPHA_DEG / 2;
    if (Z === 1) return 0;
    if (Z === 2) return ALPHA_DEG;
    if (block === 'noble' || group === 18) return ALPHA_DEG;
    
    if (block === 's' || block === 'mirror') {
        if (group === 1) return 0;
        if (group === 2) return ALPHA_DEG * 0.15;
    }
    if (block === 'p') return ALPHA_DEG * (0.6 + (group - 13) / 5 * 0.35);
    if (block === 'd') return ALPHA_DEG * (0.2 + (group - 3) / 10 * 0.35);
    if (block === 'f') return ALPHA_DEG * 0.35;
    return ALPHA_DEG * 0.5;
}

function getElementPosition(phi_p_deg, period, Z) {
    if (period === 0) return { ...E0 };
    if (period === 1) {
        if (Z === 1) return { ...H };
        if (Z === 2) return { ...He };
    }
    
    const depth = period - 1;
    const t = phi_p_deg / ALPHA_DEG;
    
    // Interpolate between H and He radii, then expand
    const r_base = r_H + t * (r_He - r_H);
    const radius = r_base * Math.pow(EXPANSION, depth);
    
    // Height: interpolate and drop
    const y_base = H.y + t * (He.y - H.y);
    const y = y_base - depth * PERIOD_SPACING;
    
    // Angle with accumulated twist
    const twist = depth * GEAR_LASH * Math.PI / 180 * 3;
    const angle = t * Math.PI * 2 + twist;
    
    return {
        x: radius * Math.cos(angle),
        y: y,
        z: radius * Math.sin(angle)
    };
}

// =============================================================================
// ELEMENT DATABASE
// =============================================================================

const BLOCK_COLORS = {
    'vacuum': 0x8800FF, 's': 0xFFFFFF, 'noble': 0x00FFFF,
    'p': 0xFFD700, 'd': 0x4ECDC4, 'f': 0xFF6B6B, 'mirror': 0xFF00FF
};

const ELEMENTS = {};

function initElements() {
    ELEMENTS['E0'] = { Z: 0, name: 'Vacuum', period: 0, group: 0, block: 'vacuum' };
    ELEMENTS['H'] = { Z: 1, name: 'Hydrogen', period: 1, group: 1, block: 's' };
    ELEMENTS['He'] = { Z: 2, name: 'Helium', period: 1, group: 18, block: 'noble' };
    
    [['Li',3,1,'s'],['Be',4,2,'s'],['B',5,13,'p'],['C',6,14,'p'],
     ['N',7,15,'p'],['O',8,16,'p'],['F',9,17,'p'],['Ne',10,18,'noble']].forEach(
        ([s,z,g,b]) => ELEMENTS[s] = {Z:z,name:s,period:2,group:g,block:b});
    
    [['Na',11,1,'s'],['Mg',12,2,'s'],['Al',13,13,'p'],['Si',14,14,'p'],
     ['P',15,15,'p'],['S',16,16,'p'],['Cl',17,17,'p'],['Ar',18,18,'noble']].forEach(
        ([s,z,g,b]) => ELEMENTS[s] = {Z:z,name:s,period:3,group:g,block:b});
    
    ELEMENTS['K'] = {Z:19,name:'Potassium',period:4,group:1,block:'s'};
    ELEMENTS['Ca'] = {Z:20,name:'Calcium',period:4,group:2,block:'s'};
    ['Sc','Ti','V','Cr','Mn','Fe','Co','Ni','Cu','Zn'].forEach((s,i) => 
        ELEMENTS[s] = {Z:21+i,name:s,period:4,group:3+i,block:'d'});
    ['Ga','Ge','As','Se','Br'].forEach((s,i) => 
        ELEMENTS[s] = {Z:31+i,name:s,period:4,group:13+i,block:'p'});
    ELEMENTS['Kr'] = {Z:36,name:'Krypton',period:4,group:18,block:'noble'};
    
    ELEMENTS['Rb'] = {Z:37,name:'Rubidium',period:5,group:1,block:'s'};
    ELEMENTS['Sr'] = {Z:38,name:'Strontium',period:5,group:2,block:'s'};
    ['Y','Zr','Nb','Mo','Tc','Ru','Rh','Pd','Ag','Cd'].forEach((s,i) => 
        ELEMENTS[s] = {Z:39+i,name:s,period:5,group:3+i,block:'d'});
    ['In','Sn','Sb','Te','I'].forEach((s,i) => 
        ELEMENTS[s] = {Z:49+i,name:s,period:5,group:13+i,block:'p'});
    ELEMENTS['Xe'] = {Z:54,name:'Xenon',period:5,group:18,block:'noble'};
    
    ELEMENTS['Cs'] = {Z:55,name:'Cesium',period:6,group:1,block:'s'};
    ELEMENTS['Ba'] = {Z:56,name:'Barium',period:6,group:2,block:'s'};
    ['La','Ce','Pr','Nd','Pm','Sm','Eu','Gd','Tb','Dy','Ho','Er','Tm','Yb','Lu'].forEach((s,i) => 
        ELEMENTS[s] = {Z:57+i,name:s,period:6,group:3,block:'f'});
    ['Hf','Ta','W','Re','Os','Ir','Pt','Au','Hg'].forEach((s,i) => 
        ELEMENTS[s] = {Z:72+i,name:s,period:6,group:4+i,block:'d'});
    ['Tl','Pb','Bi','Po','At'].forEach((s,i) => 
        ELEMENTS[s] = {Z:81+i,name:s,period:6,group:13+i,block:'p'});
    ELEMENTS['Rn'] = {Z:86,name:'Radon',period:6,group:18,block:'noble'};
    
    ELEMENTS['Fr'] = {Z:87,name:'Francium',period:7,group:1,block:'s'};
    ELEMENTS['Ra'] = {Z:88,name:'Radium',period:7,group:2,block:'s'};
    ['Ac','Th','Pa','U','Np','Pu','Am','Cm','Bk','Cf','Es','Fm','Md','No','Lr'].forEach((s,i) => 
        ELEMENTS[s] = {Z:89+i,name:s,period:7,group:3,block:'f'});
    ['Rf','Db','Sg','Bh','Hs','Mt','Ds','Rg','Cn'].forEach((s,i) => 
        ELEMENTS[s] = {Z:104+i,name:s,period:7,group:4+i,block:'d'});
    ['Nh','Fl','Mc','Lv','Ts'].forEach((s,i) => 
        ELEMENTS[s] = {Z:113+i,name:s,period:7,group:13+i,block:'p'});
    ELEMENTS['Og'] = {Z:118,name:'Oganesson',period:7,group:18,block:'noble'};
    
    ELEMENTS['Uue'] = {Z:119,name:'Ununennium',period:8,group:1,block:'mirror'};
    ELEMENTS['Ubn'] = {Z:120,name:'Unbinilium',period:8,group:2,block:'mirror'};
    
    Object.keys(ELEMENTS).forEach(sym => {
        const el = ELEMENTS[sym];
        el.phi_p = getPhiP(el.group, el.block, el.Z);
        el.color = BLOCK_COLORS[el.block] || 0xFFFFFF;
    });
    
    console.log(`\nInitialized ${Object.keys(ELEMENTS).length} elements`);
}

initElements();

// =============================================================================
// THREE.JS VISUALIZATION
// =============================================================================

let scene, camera, renderer, controls;
let labelRenderer;
let triangleGroup, axisGroup, ribbonGroup;
let elementMeshes = [];
let elementLabels = [];
let raycaster, mouse;

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a1a);

    camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(7, 4, 7);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.getElementById('container').appendChild(renderer.domElement);

    labelRenderer = new THREE.CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position = 'absolute';
    labelRenderer.domElement.style.top = '0';
    labelRenderer.domElement.style.pointerEvents = 'none';
    document.getElementById('container').appendChild(labelRenderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.set(0, 1.5, 0);

    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();

    scene.add(new THREE.AmbientLight(0xffffff, 0.4));
    const light = new THREE.DirectionalLight(0xffffff, 0.8);
    light.position.set(5, 10, 7);
    scene.add(light);

    triangleGroup = new THREE.Group();
    axisGroup = new THREE.Group();
    ribbonGroup = new THREE.Group();
    scene.add(triangleGroup);
    scene.add(axisGroup);
    scene.add(ribbonGroup);

    createTriangle();
    createAxis();
    createRibbons();
    createElements();

    document.getElementById('showTriangle').addEventListener('change', e => triangleGroup.visible = e.target.checked);
    document.getElementById('showRibbons').addEventListener('change', e => ribbonGroup.visible = e.target.checked);
    document.getElementById('showAxis').addEventListener('change', e => axisGroup.visible = e.target.checked);
    
    // Size controls
    document.getElementById('sizeSlider').addEventListener('input', e => {
        document.getElementById('sizeVal').textContent = parseFloat(e.target.value).toFixed(1);
        rebuildElements();
    });
    document.getElementById('propSize').addEventListener('change', () => rebuildElements());
    document.getElementById('showLabels').addEventListener('change', e => toggleLabels(e.target.checked));

    window.addEventListener('resize', onResize);
    window.addEventListener('mousemove', onMouse);

    animate();
}

function createTriangle() {
    const v_E0 = new THREE.Vector3(E0.x, E0.y, E0.z);
    const v_H = new THREE.Vector3(H.x, H.y, H.z);
    const v_He = new THREE.Vector3(He.x, He.y, He.z);
    
    // Edges
    const addEdge = (p1, p2, c) => triangleGroup.add(new THREE.Line(
        new THREE.BufferGeometry().setFromPoints([p1, p2]),
        new THREE.LineBasicMaterial({ color: c, linewidth: 2 })
    ));
    addEdge(v_E0, v_H, 0xFF6666);   // 3
    addEdge(v_E0, v_He, 0x66FF66);  // 4
    addEdge(v_H, v_He, 0x6666FF);   // 5
    
    // Fill
    const triGeom = new THREE.BufferGeometry();
    triGeom.setAttribute('position', new THREE.BufferAttribute(new Float32Array([
        E0.x, E0.y, E0.z, H.x, H.y, H.z, He.x, He.y, He.z
    ]), 3));
    triangleGroup.add(new THREE.Mesh(triGeom, new THREE.MeshBasicMaterial({
        color: 0xFFD700, opacity: 0.15, transparent: true, side: THREE.DoubleSide
    })));
    
    // Right angle indicator at E0
    const arcPoints = [];
    const arcRadius = 0.3;
    for (let i = 0; i <= 20; i++) {
        const t = i / 20;
        const toH = new THREE.Vector3(H.x - E0.x, H.y - E0.y, H.z - E0.z).normalize();
        const toHe = new THREE.Vector3(He.x - E0.x, He.y - E0.y, He.z - E0.z).normalize();
        const p = toH.clone().lerp(toHe, t).normalize().multiplyScalar(arcRadius);
        arcPoints.push(new THREE.Vector3(E0.x + p.x, E0.y + p.y, E0.z + p.z));
    }
    triangleGroup.add(new THREE.Line(
        new THREE.BufferGeometry().setFromPoints(arcPoints),
        new THREE.LineBasicMaterial({ color: 0xFFFFFF, opacity: 0.5, transparent: true })
    ));
}

function createAxis() {
    const geom = new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(0, -2, 0), new THREE.Vector3(0, APEX_HEIGHT + 0.5, 0)
    ]);
    const line = new THREE.Line(geom, new THREE.LineDashedMaterial({
        color: 0x8800FF, dashSize: 0.1, gapSize: 0.05, opacity: 0.6, transparent: true
    }));
    line.computeLineDistances();
    axisGroup.add(line);
}

function createRibbons() {
    for (let period = 2; period <= 8; period++) {
        const points = [];
        for (let i = 0; i <= 100; i++) {
            const phi = (i / 100) * ALPHA_DEG;
            const pos = getElementPosition(phi, period, 0);
            points.push(new THREE.Vector3(pos.x, pos.y, pos.z));
        }
        const curve = new THREE.CatmullRomCurve3(points);
        const tubeGeom = new THREE.TubeGeometry(curve, 100, 0.02, 8, false);
        ribbonGroup.add(new THREE.Mesh(tubeGeom, new THREE.MeshBasicMaterial({
            color: period === 8 ? 0xFF00FF : 0x444466,
            transparent: true, opacity: period === 8 ? 0.8 : 0.3
        })));
    }
}

function getElementRadius(sym, el, globalScale, useProportional) {
    let base = 0.06;
    if (sym === 'E0') base = 0.12;
    else if (el.period === 1) base = 0.10;
    else if (sym === 'C') base = 0.08;
    else if (el.block === 'noble') base = 0.07;
    else if (el.block === 'mirror') base = 0.10;
    
    // Apply proportional scaling based on cube root of Z
    if (useProportional && el.Z > 0) {
        const zFactor = Math.pow(el.Z, 1/3) / Math.pow(6, 1/3);  // Normalized to Carbon
        base *= zFactor;
    }
    
    return base * globalScale;
}

function createElements() {
    const globalScale = parseFloat(document.getElementById('sizeSlider').value);
    const useProportional = document.getElementById('propSize').checked;
    const showLabels = document.getElementById('showLabels').checked;
    
    Object.keys(ELEMENTS).forEach(sym => {
        const el = ELEMENTS[sym];
        const pos = getElementPosition(el.phi_p, el.period, el.Z);
        
        const r = getElementRadius(sym, el, globalScale, useProportional);
        
        const mesh = new THREE.Mesh(
            new THREE.SphereGeometry(r, 20, 20),
            new THREE.MeshStandardMaterial({
                color: el.color, metalness: 0.3, roughness: 0.4,
                emissive: el.color, emissiveIntensity: 0.15
            })
        );
        mesh.position.set(pos.x, pos.y, pos.z);
        mesh.userData = { ...el, sym };
        scene.add(mesh);
        elementMeshes.push(mesh);
        
        // Create label
        const labelDiv = document.createElement('div');
        labelDiv.className = 'element-label hidden';
        labelDiv.textContent = sym;
        const label = new THREE.CSS2DObject(labelDiv);
        label.position.set(0, r + 0.05, 0);
        mesh.add(label);
        elementLabels.push({ label, div: labelDiv });
    });
    
    // Apply visibility based on checkbox
    toggleLabels(showLabels);
}

function rebuildElements() {
    // Remove existing labels first
    elementLabels.forEach(({ label, div }) => {
        if (label.parent) label.parent.remove(label);
        if (div.parentNode) div.parentNode.removeChild(div);
    });
    elementLabels = [];
    
    // Remove existing meshes
    elementMeshes.forEach(m => {
        scene.remove(m);
        if (m.geometry) m.geometry.dispose();
        if (m.material) m.material.dispose();
    });
    elementMeshes = [];
    
    // Recreate
    createElements();
}

function toggleLabels(visible) {
    elementLabels.forEach(({ div }) => {
        if (visible) {
            div.classList.remove('hidden');
        } else {
            div.classList.add('hidden');
        }
    });
}

function onMouse(e) {
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    
    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(elementMeshes);
    const tip = document.getElementById('tooltip');
    
    if (hits.length) {
        const d = hits[0].object.userData;
        tip.innerHTML = `<b>${d.sym}</b> ${d.name}<br>Z=${d.Z} Period ${d.period}<br>œÜ_p = ${d.phi_p.toFixed(2)}¬∞`;
        tip.style.display = 'block';
        tip.style.left = (e.clientX + 12) + 'px';
        tip.style.top = (e.clientY + 12) + 'px';
    } else {
        tip.style.display = 'none';
    }
}

function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
    labelRenderer.render(scene, camera);
}

init();
    </script>
</body>
</html>
